services:
  spark-1:
    build: ./spark
    container_name: spark-1
    hostname: spark-1
    networks:
      - sparknet
    depends_on:
      - hive
    mem_limit: 12g
    memswap_limit: 12g
    cpus: 4
    cap_add:
      - NET_ADMIN
    environment:
      - SPARK_HOST_NAME=spark-1
      - SPARK_PORT=7077
      - SPARK_WEB_PORT=8080
      - METASTORE_HOSTNAME=hive
      - METASTORE_PORT=9083
    ports:
      - "7077:7077"
      - "8080:8080"
      - "4040:4040"
    volumes:
      - ./data:/data
      - ./workloads:/workloads
      - spark-events:/opt/spark/spark-events
      - ivy-cache:/root/.ivy2

  spark-2:
    build: ./spark
    container_name: spark-2
    hostname: spark-2
    networks:
      - sparknet
    depends_on:
      - hive
    mem_limit: 8g
    memswap_limit: 8g
    cpus: 2
    cap_add:
      - NET_ADMIN
    environment:
      - SPARK_HOST_NAME=spark-2
      - SPARK_PORT=7078
      - SPARK_WEB_PORT=8081
      - METASTORE_HOSTNAME=hive
      - METASTORE_PORT=9083
    ports:
      - "7078:7078"
      - "8081:8081"
    volumes:
      - ./data:/data
      - spark-events:/opt/spark/spark-events
      - ivy-cache:/root/.ivy2

  spark-3:
    build: ./spark
    container_name: spark-3
    hostname: spark-3
    networks:
      - sparknet
    depends_on:
      - hive
    mem_limit: 8g
    memswap_limit: 8g
    cpus: 2
    cap_add:
      - NET_ADMIN
    environment:
      - SPARK_HOST_NAME=spark-3
      - SPARK_PORT=7079
      - SPARK_WEB_PORT=8082
      - METASTORE_HOSTNAME=hive
      - METASTORE_PORT=9083
    ports:
      - "7079:7079"
      - "8082:8082"
    volumes:
      - ./data:/data
      - spark-events:/opt/spark/spark-events
      - ivy-cache:/root/.ivy2

  postgres:
    image: postgres:16
    container_name: postgres
    hostname: postgres
    networks:
      - sparknet
    mem_limit: 1g
    memswap_limit: 1g
    environment:
      - POSTGRES_USER=hive
      - POSTGRES_PASSWORD=hive
      - POSTGRES_DB=metastore
    volumes:
      - postgres-data:/var/lib/postgresql/data

  hive:
    build: ./hive
    container_name: hive
    hostname: hive
    networks:
      - sparknet
    depends_on:
      - postgres
    mem_limit: 2g
    memswap_limit: 2g
    environment:
      - METASTORE_DB_HOSTNAME=postgres
    ports:
      - "9083:9083"

networks:
  sparknet:
    driver: bridge

volumes:
  spark-events:
  postgres-data:
  ivy-cache:
